global
    log /dev/log local0
    log /dev/log local1 notice
    daemon

    # generated 2026-01-10, Mozilla Guideline v5.7, HAProxy 3.0, OpenSSL 3.5.4, intermediate config
    # https://ssl-config.mozilla.org/#server=haproxy&version=3.0&config=intermediate&openssl=3.5.4&guideline=5.7
    ssl-default-bind-curves X25519:prime256v1:secp384r1
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options prefer-client-ciphers ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-curves X25519:prime256v1:secp384r1
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-dh-param-file /etc/haproxy/dh2048.pem

defaults
    log global
    option httplog
    option http-server-close
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    timeout tunnel 1h

frontend fe_stats
    bind {{ vps_wg_private_ip }}:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends

frontend fe_tcp
    bind :80
    bind :443
    mode tcp
    option tcplog
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 } or !{ req.ssl_hello_type 1 }

    acl acl_teleport_sni req.ssl_sni -i tele.{{ inventory__site }}
    acl acl_teleport_sni req.ssl_sni -i -m end .tele.{{ inventory__site }}
    acl acl_teleport_sni req.ssl_sni -i -m reg ^[0-9a-f]+\.teleport\.cluster\.local$
    use_backend be_teleport if acl_teleport_sni

    acl acl_connect_sni req.ssl_sni -i -m end {{ inventory__sing_box_config.server_name }}
    use_backend be_connect if acl_connect_sni

    use_backend tcp_to_http if { dst_port 80 }
    default_backend tcp_to_https

frontend fe_http
    bind 127.0.0.1:8080 accept-proxy
    bind 127.0.0.1:8443 accept-proxy ssl crt /etc/haproxy/certs
    mode http
    option httplog
    http-request set-var(txn.req_hdrs) req.hdrs
    log-format "${HAPROXY_HTTP_LOG_FMT} hdrs:%{+Q}[var(txn.req_hdrs)]"

    http-request redirect scheme https if !{ ssl_fc }

    option forwardfor
    http-request del-header X-Forwarded-For
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header Host %[req.hdr(Host)]

    # acl acl_be_cml req.hdr(Host) -i llama-swap.ai.{{ inventory__site }}
    acl acl_be_cml req.hdr(Host) -i chat.ai.{{ inventory__site }}
    use_backend be_cml if acl_be_cml

    default_backend be_no_match

backend tcp_to_http
    mode http
    # check port set to downgrade TCP check without the proxy protocol https://github.com/haproxy/haproxy/issues/2498
    server local_8080 127.0.0.1:8080 send-proxy-v2-ssl-cn check port 8080

backend tcp_to_https
    mode tcp
    # check port set to downgrade TCP check without the proxy protocol https://github.com/haproxy/haproxy/issues/2498
    server local_8443 127.0.0.1:8443 send-proxy-v2-ssl-cn check port 8443

backend be_cml
    mode http
    server cml {{ vps_wg_peers[1].private_ip }}:8443 check ssl verify none alpn h2,http/1.1

backend be_teleport
    mode tcp
    option tcp-check
    server teleport {{ vps_wg_peers[0].private_ip }}:10443 send-proxy check

backend be_connect
    mode tcp
    option tcp-check
    server connect vps-sd-ams.devmem.ru:443 check

backend be_no_match
    mode http
    http-request deny
